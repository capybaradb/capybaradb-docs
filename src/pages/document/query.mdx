import LanguageToggle from "../../components/LanguageToggle";
import LanguageContent from "../../components/LanguageContent";
import { Callout } from "nextra/components";

# Query

<LanguageToggle />

This guide explains how to perform semantic queries on documents in CapybaraDB. The query operation retrieves documents based on semantic matches to the provided query text. Optional parameters like emb_model, top_k, and projection allow you to control the embedding model used, the number of results, and the fields returned. The examples below demonstrate how to leverage EmbJSON for effective semantic searches.

### Example: Code for `query` Operation

<LanguageContent lang="python">

Below is an example of how to perform a semantic query using Python. This example includes **EmbJSON** fields that align with the type of data you may have inserted previously:

```python filename="Python" showLineNumbers
query_text = "Software engineer with expertise in AI"
emb_model = "text-embedding-3-small"
top_k = 3
include_values = True
projection = {
    "mode": "include",
    "fields": ["name", "bio"]
}

response = collection.query(query)
```

</LanguageContent>

<LanguageContent lang="typescript">

Below is an example of how to perform a semantic query using Python. This example includes **EmbJSON** fields that align with the type of data you may have inserted previously:

```typescript filename="TypeScript" showLineNumbers
const queryText = "Software engineer with expertise in AI";
const embModel = "text-embedding-3-small";
const topK = 3;
const includeValues = true;
const projection = {
  mode: "include",
  fields: ["name", "bio"],
};
```

</LanguageContent>

### Query Response

A successful query operation will return a JSON response containing matched **chunks** sorted by semantic similarity. Below is an example response:

```json filename="JSON" showLineNumbers
{
  "matches": [
    {
      "document": {
        "name": "John Doe",
        "bio": {
          "@embText": {
            "text": "John is a software engineer with expertise in AI.",
            "model": "text-embedding-3-small"
          }
        }
      },
      "path": "bio",
      "chunk": "John is a software engineer with expertise in AI.",
      "chunk_n": 0,
      "score": 0.95,
      "values": [
        0.123, 0.456, 0.789, ...
      ]
    },
    {
      "document": {
        "name": "Alice Smith",
        "bio": {
          "@embText": {
            "text": "Alice is a data scientist with a background in machine learning.",
            "model": "text-embedding-3-small"
          }
        }
      },
      "path": "bio",
      "chunk": "Alice is a data scientist with a background in machine learning.",
      "chunk_n": 1,
      "score": 0.89,
      "values": [
        0.234, 0.567, 0.890, ...
      ]
    }
  ]
}
```

The matches field contains an array of documents that were semantically matched, with additional metadata about the matched chunks, such as path, chunk, score, and values if requested. Note that only documents containing **EmbJSON** fields are returned in the response.

### Example Response When Omitting projection

If the projection parameter is omitted, the default behavior is to exclude all fields except the \_id field. Below is an example response:

```json filename="JSON" showLineNumbers
{
  "matches": [
    {
      "document": {
        "_id": "64d2f8f01234abcd5678ef90"
      },
      "path": "bio",
      "chunk": "John is a software engineer with expertise in AI.",
      "chunk_n": 0,
      "score": 0.95,
      "values": [
        0.123, 0.456, 0.789, ...
      ]
    },
    {
      "document": {
        "_id": "64d2f8f01234abcd5678ef91"
      },
      "path": "bio",
      "chunk": "Alice is a data scientist with a background in machine learning.",
      "chunk_n": 1,
      "score": 0.89,
      "values": [
        0.234, 0.567, 0.890, ...
      ]
    }
  ]
}
```

In this response, only the \_id field is included in the document since the projection parameter was not specified.

### Query Parameters

| Parameter                     | Description                                                                                                                                                                                                                                                                                                                        | Data Type / Format |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| **query**                     | The text to be embedded and matched against stored EmbJSON fields. This parameter is required.                                                                                                                                                                                                                                     | string             |
| **emb_model** (optional)      | The embedding model used for the query. Defaults to OpenAI's text-embedding-3-small. Users can select from supported embedding models listed at /models. Refer to [Supported Embedding Models](#) for more details. If the specified model does not match those used in the stored EmbJSON, only matching fields will be targeted. | string             |
| **top_k** (optional)          | Specifies the maximum number of top-matching chunks to return, sorted by semantic similarity. Default is 10. Use **top_k** to control how many chunks are returned, ensuring you receive the most relevant semantic matches.                                                                                                       | integer            |
| **include_values** (optional) | Boolean flag to include vector values for each matched chunk in the response. Default is false. Set **include_values** to true to include the actual vector values of each matched chunk in the response.                                                                                                                          | boolean            |
| **projection** (optional)     | Defines which fields to return in the response. The default value is `{ "mode": "exclude" }`. Accepts a required `mode` (include or exclude) and an optional `fields` list. See the table below for how different values of `projection` affect the response.                                                                      | JSON object        |

<Callout type="info">

### Format of `projection` Parameter

| Key        | Description                                                                                | Format                                   |
| ---------- | ------------------------------------------------------------------------------------------ | ---------------------------------------- |
| **mode**   | **Required.** Specifies whether to include or exclude certain fields in the response.      | string (`"include"` or `"exclude"`)      |
| **fields** | **Optional.** A list of specific fields to include or exclude based on the `mode` setting. | list of strings (`["field1", "field2"]`) |

### Projection Parameter Scenarios

| Example Projection Value                               | Result                                               |
| ------------------------------------------------------ | ---------------------------------------------------- |
| `{ "mode": "include" }`                                | The entire document is returned.                     |
| `{ "mode": "include", "fields": ["title", "author"] }` | Only the `title` and `author` fields are returned.   |
| `{ "mode": "exclude" }`                                | Only the `_id` field is returned.                    |
| `{ "mode": "exclude", "fields": ["title", "author"] }` | All fields except `title` and `author` are returned. |

</Callout>

### Got questions? [Email us](mailto:hello@capybaradb.co)
